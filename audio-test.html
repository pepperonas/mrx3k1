<!DOCTYPE html>
<html>
<head>
    <title>Audio Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2C2E3B;
            color: white;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        button {
            padding: 10px;
            margin: 10px;
            background-color: #4C6EF5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #dropZone {
            border: 2px dashed #666;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
        }

        #waveform {
            height: 100px;
            background-color: #383A4A;
            margin: 20px 0;
        }

        #log {
            background-color: #383A4A;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<h1>Audio-Datei Test</h1>

<div id="dropZone">
    Drag & Drop Audio-Datei hier oder
    <input type="file" id="fileInput" accept="audio/*">
</div>

<div>
    <button id="playButton" disabled>Abspielen</button>
    <span id="fileInfo"></span>
</div>

<div id="waveform"></div>

<audio id="audioPlayer" controls style="width: 100%; margin: 20px 0;"></audio>

<h3>Debug Log:</h3>
<div id="log"></div>

<script>
    // Logger-Funktion
    function log(message) {
        const logElement = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logElement.innerHTML += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
    }

    // Override console.log für Debug-Zwecke
    const originalConsoleLog = console.log;
    console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        log(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '));
    };

    // Override console.error für Debug-Zwecke
    const originalConsoleError = console.error;
    console.error = function (...args) {
        originalConsoleError.apply(console, args);
        log('ERROR: ' + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '));
    };

    // Audio-Elemente
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const audioPlayer = document.getElementById('audioPlayer');
    const playButton = document.getElementById('playButton');
    const fileInfo = document.getElementById('fileInfo');
    const waveform = document.getElementById('waveform');

    // Audio-Kontexte
    let audioContext = null;
    let audioBuffer = null;

    // Event-Listener
    fileInput.addEventListener('change', handleFileSelect);
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    playButton.addEventListener('click', togglePlayback);

    // Audio-Initialisierung
    function initAudioContext() {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            log('AudioContext erstellt: ' + audioContext.state);

            // Entsperren des AudioContext, falls nötig
            if (audioContext.state === 'suspended') {
                log('AudioContext ist suspendiert, versuche zu entsperren...');
                const unlock = () => {
                    audioContext.resume().then(() => {
                        log('AudioContext entsperrt: ' + audioContext.state);
                        document.removeEventListener('click', unlock);
                    });
                };
                document.addEventListener('click', unlock);
            }

            return audioContext;
        } catch (e) {
            console.error('AudioContext konnte nicht erstellt werden:', e);
            return null;
        }
    }

    // File-Handler
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            processAudioFile(file);
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        const file = e.dataTransfer.files[0];
        if (file && file.type.includes('audio')) {
            processAudioFile(file);
        } else {
            log('Keine Audio-Datei erkannt');
        }
    }

    // Audio-Verarbeitung
    async function processAudioFile(file) {
        log(`Datei ausgewählt: ${file.name} (${file.type}, ${file.size} Bytes)`);
        fileInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

        // Direktes Laden in das Audio-Element
        const objectURL = URL.createObjectURL(file);
        audioPlayer.src = objectURL;
        audioPlayer.load();

        audioPlayer.onloadedmetadata = () => {
            log(`Audio-Metadaten geladen: Dauer = ${audioPlayer.duration.toFixed(2)}s`);
            playButton.disabled = false;
        };

        audioPlayer.onerror = (e) => {
            console.error('Fehler beim Laden der Audio-Datei:', audioPlayer.error);
        };

        // Waveform generieren
        if (!audioContext) {
            initAudioContext();
        }

        if (audioContext) {
            try {
                log('Lese Datei als ArrayBuffer...');
                const arrayBuffer = await file.arrayBuffer();
                log(`ArrayBuffer erhalten: ${arrayBuffer.byteLength} Bytes`);

                log('Dekodiere Audio...');
                audioContext.decodeAudioData(arrayBuffer,
                    (buffer) => {
                        log(`Audio dekodiert: ${buffer.duration.toFixed(2)}s, ${buffer.numberOfChannels} Kanäle, ${buffer.sampleRate}Hz`);
                        audioBuffer = buffer;
                        drawWaveform(buffer);
                    },
                    (err) => {
                        console.error('Fehler beim Dekodieren:', err);
                    }
                );
            } catch (err) {
                console.error('Fehler beim Verarbeiten der Datei:', err);
            }
        }
    }

    // Waveform zeichnen
    function drawWaveform(buffer) {
        const width = waveform.clientWidth;
        const height = waveform.clientHeight;
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        waveform.innerHTML = '';
        waveform.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#2C2E3B';
        ctx.fillRect(0, 0, width, height);

        const data = buffer.getChannelData(0);
        const step = Math.ceil(data.length / width);
        const amp = height / 2;

        ctx.fillStyle = '#6C7EE1';

        for (let i = 0; i < width; i++) {
            let min = 1.0;
            let max = -1.0;

            for (let j = 0; j < step; j++) {
                const datum = data[(i * step) + j];
                if (datum < min) min = datum;
                if (datum > max) max = datum;
            }

            ctx.fillRect(i, (1 + min) * amp, 1, Math.max(1, (max - min) * amp));
        }

        log('Waveform gezeichnet');
    }

    // Playback-Steuerung
    function togglePlayback() {
        if (audioPlayer.paused) {
            audioPlayer.play().then(() => {
                log('Audio-Wiedergabe gestartet');
            }).catch(err => {
                console.error('Fehler beim Starten der Wiedergabe:', err);
            });
        } else {
            audioPlayer.pause();
            log('Audio-Wiedergabe pausiert');
        }
    }

    // Initialisierung beim Laden
    log('Audio-Test-Seite geladen');
    initAudioContext();
</script>
</body>
</html>